#!/usr/bin/env bash
set -e

# Function to log messages
log() {
    echo "[postgres] $1"
}

# Wait for database initialization
while [ ! -f /var/lib/postgresql/data/PG_VERSION ]; do
    log "Waiting for database initialization..."
    sleep 2
done

log "Starting PostgreSQL server..."

# Set environment variables
export PGDATA="/var/lib/postgresql/data"
export POSTGRES_USER="${POSTGRES_USER:-visionect}"
export POSTGRES_PASSWORD="${POSTGRES_PASSWORD:-visionect}"
export POSTGRES_DB="${POSTGRES_DB:-koala}"

# Ensure proper ownership
chown -R postgres:postgres /var/lib/postgresql

# Start PostgreSQL
exec su-exec postgres postgres \
    -D /var/lib/postgresql/data \
    -c listen_addresses=localhost \
    -c port=5432 \
    -c log_destination=stderr \
    -c logging_collector=off \
    -c log_min_messages=warning
